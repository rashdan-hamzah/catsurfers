<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Cat Surfers</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no,maximum-scale=1.0">
  <style>
    html, body {
      margin: 0; padding: 0;
      background: #b9eaff;
      font-family: 'Segoe UI', Arial, sans-serif;
      user-select: none;
      -webkit-user-select: none;
      overflow: hidden;
      touch-action: none;
      /* Prevent iOS bounce/scroll */
      overscroll-behavior: none;
      height: 100%;
      width: 100vw;
      min-height: 100vh;
    }
    body {
      width: 100vw; min-height: 100vh; height: 100vh;
    }
    #game-container {
      width: 100vw;
      height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      background: linear-gradient(180deg, #b9eaff 75%, #f7d57a 99%);
      position: relative;
      overflow: hidden;
    }
    #gameCanvas {
      display: block;
      background: transparent;
      margin: 0 auto;
      border-radius: 14px;
      margin-top: 0;
      touch-action: none;
      /* Prevent double-tap zoom, selection */
      -webkit-user-select: none;
      user-select: none;
    }
    #scoreboard {
      position: absolute;
      top: 10px; left: 0; right: 0;
      width: 100vw;
      display: flex;
      justify-content: space-between;
      padding: 0 30px;
      font-size: 1.35em;
      font-weight: bold;
      color: #fffbe0;
      letter-spacing: 0.5px;
      text-shadow: 2px 2px 6px #29292955;
      z-index: 11;
      pointer-events: none;
    }
    #stats {
      position: absolute;
      top: 54px;
      left: 0; right: 0;
      width: 100vw;
      display: flex;
      gap: 30px;
      justify-content: center;
      font-size: 1em;
      font-weight: 600;
      color: #245073;
      letter-spacing: 1px;
      z-index: 11;
      pointer-events: none;
      filter: drop-shadow(0 3px 2px #fff7);
    }
    .stat-bar {
      width: 70px;
      height: 9px;
      border-radius: 5px;
      background: #d8e6e3;
      margin-left: 6px;
      display: inline-block;
      vertical-align: middle;
      overflow: hidden;
      position: relative;
    }
    .bar-inner { height: 100%; border-radius: 5px; transition: width 0.3s; position: absolute; left: 0; top: 0; }
    .hunger-bar { background: linear-gradient(90deg, #fff47c, #f1b80c); }
    .happiness-bar { background: linear-gradient(90deg, #45ecc8, #169e6e); }
    .energy-bar { background: linear-gradient(90deg, #b1e0ff, #2066b0); }
    #controls {
      position: absolute;
      bottom: 44px;
      left: 0; right: 0;
      display: flex;
      gap: 12px;
      justify-content: center;
      z-index: 14;
    }
    #controls button {
      font-size: 1.07em;
      border: none;
      border-radius: 10px;
      background: #fff5c6;
      color: #564200;
      padding: 9px 17px;
      cursor: pointer;
      font-weight: 650;
      box-shadow: 0 4px 13px rgba(0,0,0,0.09);
      transition: background 0.14s, color 0.14s;
      outline: none;
    }
    #controls button:disabled {
      background: #e0cba0;
      color: #a7a7a7;
      cursor: not-allowed;
    }
    #controls button:hover, #controls button:focus {
      background: #ffe35e;
      color: #c15800;
    }
    #message {
      position: absolute;
      top: 87px; left: 0; right: 0;
      text-align: center;
      font-size: 1.10em;
      color: #276f97;
      font-weight: 650;
      letter-spacing: 1px;
      min-height: 18px;
      z-index: 13;
      pointer-events: none;
      text-shadow: 0 1px 4px #fff7;
    }
    #overlay {
      display: none;
      position: fixed;
      left: 0; top: 0; right: 0; bottom: 0;
      background: rgba(36, 44, 66, 0.20);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }
    #overlay.active {
      display: flex;
    }
    #overlay-content {
      background: #fff;
      border-radius: 18px;
      box-shadow: 0 4px 22px #0002;
      padding: 36px 25px 22px 25px;
      text-align: center;
      min-width: 230px;
      max-width: 95vw;
    }
    #overlay-content h2 { margin: 0 0 16px 0; color: #1d3f58; }
    #overlay-content p { margin: 0 0 16px 0; color: #436e86; font-size: 1.11em; }
    #overlay-content button {
      margin-top: 13px;
      font-size: 1.09em;
      background: #45ecc8;
      color: #145a31;
      border: none;
      border-radius: 8px;
      padding: 9px 24px;
      font-weight: 700;
      cursor: pointer;
      transition: background 0.1s;
    }
    #overlay-content button:hover { background: #169e6e; color: #fff; }
    @media (max-width: 600px) {
      #gameCanvas { width: 100vw !important; height: 55vw !important; }
      #scoreboard, #stats { font-size: 0.95em; padding: 0 9vw; }
      .stat-bar { width: 36vw; max-width: 70px; }
    }
  </style>
</head>
<body>
  <div id="game-container">
    <div id="scoreboard">
      <span id="score">0</span>
      <span id="highscore">Best: 0</span>
    </div>
    <canvas id="gameCanvas" width="480" height="420" tabindex="0"></canvas>
    <div id="stats">
      <span>
        <span style="font-size:1.05em">üç£</span>
        <span class="stat-bar"><span class="bar-inner hunger-bar" id="hunger-bar"></span></span>
      </span>
      <span>
        <span style="font-size:1.05em">üò∫</span>
        <span class="stat-bar"><span class="bar-inner happiness-bar" id="happiness-bar"></span></span>
      </span>
      <span>
        <span style="font-size:1.05em">‚ö°Ô∏è</span>
        <span class="stat-bar"><span class="bar-inner energy-bar" id="energy-bar"></span></span>
      </span>
    </div>
    <div id="controls">
      <button id="feedBtn">üç£ Feed</button>
      <button id="petBtn">üêæ Pet</button>
      <button id="sleepBtn">üò¥ Sleep</button>
    </div>
    <div id="message"></div>
    <div id="overlay">
      <div id="overlay-content">
        <h2 id="overlay-title"></h2>
        <p id="overlay-msg"></p>
        <button id="restartBtn">Start</button>
      </div>
    </div>
  </div>
  <script>
    // ===== VISUALS & GAME DIMENSIONS =====
    const CANVAS = document.getElementById('gameCanvas');
    const CTX = CANVAS.getContext('2d');
    // Responsive canvas
    function fitCanvas() {
      const w = window.innerWidth, h = window.innerHeight;
      // 3-lane, portrait
      let cw = Math.min(480, w, h*1.1), ch = Math.round(cw*0.875);
      // Minimum height for mobile
      if (h < 500) ch = Math.max(ch, 320);
      CANVAS.width = cw;
      CANVAS.height = ch;
      CANVAS.style.width = cw + "px";
      CANVAS.style.height = ch + "px";
      GAME.CW = cw; GAME.CH = ch;
    }
    // ===== CAT & GAME CONSTANTS =====
    const LANES = [0, 1, 2]; // left, center, right
    const COLORS = {
      sky: ["#b9eaff", "#f7d57a"],
      sunset: ["#f5d3ff", "#ffb964"],
      night: ["#3a5c77", "#222945"],
      ground: "#ffe35e",
      road: "#f3e5c0",
      side: "#e7d18a"
    };
    const CAT = {
      lane: 1,
      x: 0, y: 0, vy: 0,
      width: 54, height: 54,
      jumpV: -11.8,
      isJumping: false,
      isDucking: false,
      duckTimer: 0,
      animFrame: 0,
      animTick: 0,
      state: "run", // run, jump, duck, hurt, sleep
      mood: "normal", // happy, normal, sad, tired, sleepy
      canControl: true
    };
    // Tamagotchi Stats
    const STATS = { hunger: 100, happiness: 100, energy: 100 };
    // Game State
    let GAME = {
      running: false,
      gameover: false,
      paused: false,
      score: 0,
      highscore: 0,
      speed: 6,
      lanes: 3, // 0,1,2
      laneY: 0,
      groundY: 0,
      bgOffset: 0,
      ticks: 0,
      lastStatsTick: 0,
      foodOnGround: null,
      petPopup: 0,
      theme: "day", // day, sunset, night
      CW: 480,
      CH: 420
    };
    // Obstacles
    const OBSTACLES = [];
    const OBSTACLE_TYPES = [
      { type:"crate", width:48, height:48, lane:1, color:"#c77c41" },
      { type:"dog", width:48, height:44, lane:0, color:"#d4a373" },
      { type:"yarn", width:38, height:38, lane:2, color:"#fa9bb2" },
      { type:"fishbone", width:32, height:24, lane:0, color:"#94c2ef" },
      { type:"cone", width:32, height:38, lane:2, color:"#ffa34c" }
    ];

    // ====== UTILITIES & UI ======
    function setStatBar(bar, value) {
      bar.style.width = `${Math.max(0, Math.min(100, value))}%`;
    }
    function updateStatsUI() {
      setStatBar(document.getElementById('hunger-bar'), STATS.hunger);
      setStatBar(document.getElementById('happiness-bar'), STATS.happiness);
      setStatBar(document.getElementById('energy-bar'), STATS.energy);
    }
    function displayMessage(msg, color="#276f97", duration=1400) {
      let el = document.getElementById('message');
      el.textContent = msg;
      el.style.color = color;
      if (GAME.msgTimeout) clearTimeout(GAME.msgTimeout);
      if (duration>0) GAME.msgTimeout = setTimeout(()=>{el.textContent="";},duration);
    }
    function setScore(val) {
      GAME.score = val;
      document.getElementById('score').textContent = Math.floor(GAME.score);
      if (GAME.score > GAME.highscore) {
        GAME.highscore = GAME.score;
        document.getElementById('highscore').textContent = "Best: " + Math.floor(GAME.highscore);
        localStorage.setItem('catsurfers_highscore', GAME.highscore);
      }
    }
    function setTheme(theme) {
      GAME.theme = theme;
      let [c1,c2] = COLORS[theme==="day"?"sky":theme];
      document.getElementById('game-container').style.background =
        `linear-gradient(180deg, ${c1} 75%, ${c2} 99%)`;
    }
    function randomInt(a,b){return Math.floor(Math.random()*(b-a+1))+a;}
    function laneX(lane) {
      // Center of lane
      let pad = GAME.CW * 0.13;
      let laneW = (GAME.CW - pad*2) / (GAME.lanes-1);
      return pad + lane*laneW - CAT.width/2;
    }
    function getLaneY() {
      // Cat Y for ground
      return GAME.CH - 92;
    }
    function getObstacleY(type) {
      if (type==="crate"||type==="dog"||type==="cone"||type==="yarn") return GAME.CH-92;
      if (type==="fishbone") return GAME.CH-70;
      return GAME.CH-92;
    }
    function getObstacleHeight(type) {
      if (type==="fishbone") return 24;
      if (type==="cone"||type==="yarn") return 38;
      return 48;
    }
    // ===== MAIN GAME LOGIC =====
    function resetGame(full=true) {
      GAME.running = true;
      GAME.gameover = false;
      GAME.score = 0;
      GAME.speed = 6;
      GAME.bgOffset = 0;
      GAME.ticks = 0;
      GAME.lastStatsTick = 0;
      GAME.foodOnGround = null;
      OBSTACLES.length = 0;
      setTheme("day");
      CAT.lane = 1;
      CAT.x = laneX(1);
      CAT.y = getLaneY();
      CAT.vy = 0;
      CAT.isJumping = false;
      CAT.isDucking = false;
      CAT.duckTimer = 0;
      CAT.state = "run";
      CAT.animFrame = 0;
      CAT.animTick = 0;
      CAT.mood = "normal";
      CAT.canControl = true;
      updateStatsUI();
      setScore(0);
      if (full) STATS.hunger=100,STATS.happiness=100,STATS.energy=100;
      hideOverlay();
    }
    function showOverlay(title, msg) {
      document.getElementById('overlay').classList.add('active');
      document.getElementById('overlay-title').textContent = title;
      document.getElementById('overlay-msg').innerHTML = msg;
      document.getElementById('restartBtn').focus();
      GAME.running = false;
    }
    function hideOverlay() {
      document.getElementById('overlay').classList.remove('active');
    }
    // ===== CAT DRAWING =====
    function drawCat(x, y, state, frame, mood, isDucking) {
      CTX.save();
      // Shadow
      CTX.globalAlpha = 0.16;
      CTX.beginPath();
      CTX.ellipse(x+CAT.width/2, y+CAT.height-5, isDucking?22:27, 8, 0, 0, 2*Math.PI);
      CTX.fillStyle="#333";
      CTX.fill();
      CTX.globalAlpha = 1;
      // Main
      CTX.save();
      CTX.translate(x,y);
      if (isDucking) CTX.translate(0, 15);
      // Tail
      let tailSwing = (state==="run"||state==="jump")?Math.sin(frame/1.5)*8:0;
      CTX.strokeStyle="#a4876c";
      CTX.lineWidth=7;
      CTX.beginPath();
      CTX.moveTo(46,38);
      CTX.quadraticCurveTo(68+tailSwing,22+tailSwing,38,6+(state==="jump"?10:0));
      CTX.stroke();
      // Body
      CTX.fillStyle="#ffe4b5";
      CTX.beginPath();
      CTX.ellipse(27,33,23,17,0,0,2*Math.PI);
      CTX.fill();
      // Legs
      let lw=isDucking?14:11,lh=isDucking?8:16;
      let lY=isDucking?38:46;
      let legMove = (state==="run")?Math.sin(frame/1.5)*8:0;
      CTX.fillStyle="#fbe1ac";
      CTX.fillRect(12+legMove,lY,lw,lh);
      CTX.fillRect(31-legMove,lY,lw,lh);
      // Head
      CTX.save();
      let headTilt=(state==="jump")?-0.09:(state==="duck"?0.10:0);
      CTX.translate(27,11); CTX.rotate(headTilt); CTX.translate(-27,-11);
      // Ears
      CTX.beginPath();
      CTX.moveTo(8,17); CTX.lineTo(17,1); CTX.lineTo(24,17); CTX.closePath();
      CTX.fillStyle="#e9d8a1"; CTX.fill();
      CTX.beginPath();
      CTX.moveTo(46,17); CTX.lineTo(37,1); CTX.lineTo(30,17); CTX.closePath();
      CTX.fill();
      // Face
      CTX.beginPath();
      CTX.ellipse(27,19,15,13,0,0,2*Math.PI);
      CTX.fillStyle="#fffbe0";
      CTX.fill();
      // Cheeks
      if (mood==="happy") {
        CTX.beginPath();
        CTX.arc(16,28,4,0,2*Math.PI);
        CTX.arc(38,28,4,0,2*Math.PI);
        CTX.fillStyle="#ffb7c1";
        CTX.globalAlpha = 0.36+0.28*Math.abs(Math.sin(frame/1.5));
        CTX.fill(); CTX.globalAlpha=1.0;
      }
      // Eyes
      CTX.fillStyle="#222";
      if (state==="sleep") {
        CTX.beginPath();
        CTX.arc(19,22,4,Math.PI*0.2,Math.PI*0.8);
        CTX.arc(35,22,4,Math.PI*0.2,Math.PI*0.8);
        CTX.strokeStyle="#444"; CTX.lineWidth=2;
        CTX.stroke();
      } else if (mood==="happy") {
        CTX.beginPath();
        CTX.arc(19,22,3.8,0,2*Math.PI);
        CTX.arc(35,22,3.8,0,2*Math.PI);
        CTX.fill();
        CTX.fillStyle="#fff";
        CTX.beginPath();
        CTX.arc(20.9,21,1.3,0,2*Math.PI);
        CTX.arc(36.9,21,1.3,0,2*Math.PI);
        CTX.fill();
      } else if (mood==="sad") {
        CTX.beginPath();
        CTX.arc(19,24,2.6,Math.PI*1.2,0,false);
        CTX.arc(35,24,2.6,Math.PI,Math.PI*1.8,false);
        CTX.strokeStyle="#444"; CTX.lineWidth=2;
        CTX.stroke();
      } else {
        let blink = (frame%34===21)?0.9:3.8;
        CTX.beginPath();
        CTX.arc(19,22,blink,0,2*Math.PI);
        CTX.arc(35,22,blink,0,2*Math.PI);
        CTX.fill();
        if (blink>1.5) {
          CTX.fillStyle="#fff";
          CTX.beginPath();
          CTX.arc(20.9,21,1.3,0,2*Math.PI);
          CTX.arc(36.9,21,1.3,0,2*Math.PI);
          CTX.fill();
        }
      }
      // Nose
      CTX.beginPath();
      CTX.moveTo(27,26); CTX.lineTo(25.7,27.5); CTX.lineTo(28.3,27.5); CTX.closePath();
      CTX.fillStyle="#e38b5d";
      CTX.fill();
      // Mouth
      CTX.beginPath();
      if (state==="sleep") {} else if (mood==="happy") {
        CTX.arc(27,31,3,0,Math.PI,false);
      } else if (mood==="sad") {
        CTX.arc(27,34,3,Math.PI,2*Math.PI,true);
      } else {
        CTX.arc(27,32,2.2,0,Math.PI,false);
      }
      CTX.strokeStyle="#a3622a"; CTX.lineWidth=1.2;
      CTX.stroke();
      // Whiskers
      CTX.strokeStyle="#bba26c";
      for(let i=-1;i<=1;i+=2){
        CTX.beginPath();
        CTX.moveTo(27+i*1.5,28);
        CTX.lineTo(27+i*13,26+i*5);
        CTX.moveTo(27+i*1.5,31);
        CTX.lineTo(27+i*13,33-i*4);
        CTX.stroke();
      }
      CTX.restore();
      // Zzz (sleep)
      if (state==="sleep") drawZzz(x+37,y-7);
      // Pet popup
      if (GAME.petPopup>0) drawHeart(x+27,y-16-GAME.petPopup*0.5);
      CTX.restore();
      CTX.restore();
    }
    function drawZzz(x,y){
      CTX.save();
      CTX.font="bold 19px Arial";
      CTX.fillStyle="#4386e0";
      CTX.globalAlpha=0.7;
      CTX.fillText("Z",x,y);
      CTX.font="bold 13px Arial";
      CTX.fillText("z",x+12,y-12);
      CTX.globalAlpha=1.0; CTX.restore();
    }
    function drawHeart(x,y) {
      CTX.save();
      CTX.beginPath();
      CTX.moveTo(x,y);
      CTX.bezierCurveTo(x,y-7,x-11,y-7,x-11,y);
      CTX.bezierCurveTo(x-11,y+9,x,y+15,x,y+19);
      CTX.bezierCurveTo(x,y+15,x+11,y+9,x+11,y);
      CTX.bezierCurveTo(x+11,y-7,x,y-7,x,y);
      CTX.fillStyle="#fa9bb2";
      CTX.globalAlpha=0.8; CTX.fill();
      CTX.restore();
    }
    // ===== OBSTACLE DRAWING =====
    function drawObstacle(ob) {
      CTX.save();
      let {x,y,type,width,height,color}=ob;
      if (type==="crate") {
        CTX.fillStyle=color;
        CTX.fillRect(x,y,width,height);
        CTX.strokeStyle="#8c5832"; CTX.lineWidth=3;
        CTX.strokeRect(x+2,y+2,width-4,height-4);
      } else if (type==="dog") {
        CTX.save();
        CTX.beginPath();
        CTX.ellipse(x+width/2,y+height/2,width/2.2,height/2.2,0,0,2*Math.PI);
        CTX.fillStyle=color; CTX.fill();
        CTX.fillRect(x+7,y+8,7,19); // Left ear
        CTX.fillRect(x+width-14,y+8,7,19); // Right ear
        CTX.fillStyle="#222";
        CTX.beginPath();
        CTX.arc(x+16,y+22,3,0,2*Math.PI);
        CTX.arc(x+width-16,y+22,3,0,2*Math.PI);
        CTX.fill();
        CTX.fillStyle="#8c5832";
        CTX.beginPath();
        CTX.arc(x+width/2,y+32,2,0,2*Math.PI); CTX.fill();
        CTX.restore();
      } else if (type==="yarn") {
        CTX.beginPath();
        CTX.arc(x+width/2,y+height/2,width/2,0,2*Math.PI);
        CTX.fillStyle=color; CTX.fill();
        CTX.strokeStyle="#b23a48";
        CTX.lineWidth=1;
        for(let i=0;i<3;i++){
          CTX.beginPath();
          CTX.arc(x+width/2,y+height/2,width/2-2,i*0.7,i*0.7+1);
          CTX.stroke();
        }
        CTX.beginPath();
        CTX.moveTo(x+width/2+7,y+height/2+7);
        CTX.bezierCurveTo(x+width+6,y+height+7,x+width+10,y+height/2+18,x+width+12,y+height/2+19);
        CTX.stroke();
      } else if (type==="fishbone") {
        CTX.save();
        CTX.strokeStyle=color; CTX.lineWidth=3;
        CTX.beginPath();
        CTX.moveTo(x+4,y+height/2); CTX.lineTo(x+width-4,y+height/2); CTX.stroke();
        for(let i=0;i<3;i++){
          CTX.beginPath();
          CTX.moveTo(x+8+i*7,y+height/2-6); CTX.lineTo(x+8+i*7,y+height/2+6); CTX.stroke();
        }
        CTX.beginPath();
        CTX.arc(x+width-6,y+height/2,5,0,2*Math.PI); CTX.stroke();
        CTX.restore();
      } else if (type==="cone") {
        CTX.save();
        CTX.beginPath();
        CTX.moveTo(x+width/2,y);
        CTX.lineTo(x+width,y+height);
        CTX.lineTo(x,y+height);
        CTX.closePath();
        CTX.fillStyle=color; CTX.fill();
        CTX.strokeStyle="#d46c00"; CTX.stroke();
        CTX.restore();
      }
      CTX.restore();
    }
    // ===== GROUND, BG, DECOR =====
    function drawGround(offset) {
      CTX.save();
      // Sidewalk stripes
      for(let i=0;i<11;i++) {
        let x=(i*110-(offset%110));
        CTX.fillStyle=COLORS.side;
        CTX.fillRect(x,GAME.CH-44,70,12);
        CTX.strokeStyle="#d3b974"; CTX.lineWidth=2;
        CTX.strokeRect(x+5,GAME.CH-44,60,12);
      }
      // Main road
      CTX.fillStyle=COLORS.road;
      CTX.fillRect(0,GAME.CH-81,GAME.CW,37);
      // Main ground
      CTX.fillStyle=COLORS.ground;
      CTX.fillRect(0,GAME.CH-44,GAME.CW,44);
      CTX.restore();
    }
    function drawBackground(offset) {
      // BG: sky gradients + buildings/trees
      let theme = GAME.theme;
      if (theme==="night") {
        CTX.save();
        CTX.globalAlpha=0.7;
        CTX.beginPath();
        CTX.arc(75,56,26,0,2*Math.PI);
        CTX.fillStyle="#fffde7"; CTX.fill();
        // Stars
        for(let i=0;i<13;i++){
          CTX.save();
          CTX.globalAlpha=0.5+0.5*Math.sin(GAME.ticks/60+i*2);
          CTX.beginPath();
          CTX.arc((i*33+offset*0.3)%GAME.CW,31+(i%3)*14,1.2,0,2*Math.PI);
          CTX.fillStyle="#fff"; CTX.fill();
          CTX.restore();
        }
        CTX.restore();
      } else {
        // Neon clouds
        for(let i=0;i<5;i++){
          let cx=(i*140-(offset%560))+70;
          let cy=36+(i%2)*13;
          CTX.save();
          CTX.globalAlpha=0.22+0.13*(Math.sin(GAME.ticks/60+i)+1);
          CTX.beginPath();
          CTX.ellipse(cx,cy,46,15,0,0,2*Math.PI);
          CTX.fillStyle=theme==="sunset"?"#f8c7ff":"#fff";
          CTX.fill();
          CTX.restore();
        }
      }
      // Distant cityscape
      for(let i=0;i<4;i++){
        let x=(i*170-(offset%340));
        CTX.fillStyle=theme==="night"?"#293857":"#b0b9c6";
        CTX.fillRect(x,GAME.CH-170,68,68+randomInt(-6,14));
      }
      // Palm trees
      for(let i=0;i<3;i++){
        let px=(i*210-(offset%420))+140;
        CTX.save();
        CTX.strokeStyle="#b78e4a"; CTX.lineWidth=8;
        CTX.beginPath();
        CTX.moveTo(px,GAME.CH-81);
        CTX.lineTo(px,GAME.CH-120);
        CTX.stroke();
        CTX.strokeStyle="#61bc5e"; CTX.lineWidth=5;
        CTX.beginPath();
        CTX.arc(px,GAME.CH-124,16,Math.PI,2*Math.PI);
        CTX.stroke();
        CTX.restore();
      }
    }
    // ===== POWERUP FOOD =====
    function drawFood(food) {
      if (!food) return;
      CTX.save();
      CTX.translate(food.x, food.y);
      CTX.fillStyle="#ffe0b2";
      CTX.beginPath();
      CTX.ellipse(0,0,17,9,0,0,2*Math.PI);
      CTX.fill();
      CTX.strokeStyle="#e4a700"; CTX.stroke();
      CTX.beginPath();
      CTX.ellipse(0,-3,7,3.7,0,0,2*Math.PI);
      CTX.fillStyle="#e4a700"; CTX.globalAlpha=0.7; CTX.fill();
      CTX.globalAlpha=1;
      CTX.restore();
    }
    // ===== MAIN GAME LOOP =====
    function gameLoop() {
      if (!GAME.running) return;
      fitCanvas();
      CTX.clearRect(0,0,GAME.CW,GAME.CH);
      GAME.ticks++;
      // Theme switch like Subway Surfers vibes
      if (GAME.score>0 && Math.floor(GAME.score)%350===0 && Math.floor(GAME.score)!==0) {
        if (GAME.theme==="day") setTheme("sunset");
        else if (GAME.theme==="sunset") setTheme("night");
        else setTheme("day");
      }
      // Update speed
      GAME.speed = 7+Math.floor(GAME.score/180);
      // BG
      drawBackground(GAME.bgOffset);
      // GROUND
      drawGround(GAME.bgOffset);
      // Obstacles
      for (let i=OBSTACLES.length-1;i>=0;i--) {
        let ob=OBSTACLES[i];
        ob.x -= GAME.speed;
        drawObstacle(ob);
        if (ob.x+ob.width<0) OBSTACLES.splice(i,1);
      }
      // Cat
      CAT.animTick++;
      if (CAT.animTick%4===0) CAT.animFrame++;
      // Apply gravity
      if (!CAT.isJumping && CAT.y<getLaneY()) {
        CAT.y = getLaneY(); CAT.vy=0; CAT.state="run";
      }
      if (CAT.isJumping) {
        CAT.vy += 0.58;
        CAT.y += CAT.vy;
        if (CAT.y>=getLaneY()) {
          CAT.y=getLaneY(); CAT.vy=0; CAT.isJumping=false; CAT.state="run";
        }
      }
      if (CAT.isDucking) {
        CAT.state="duck";
        CAT.duckTimer--;
        if (CAT.duckTimer<=0) { CAT.isDucking=false; CAT.state="run"; }
      } else if (!CAT.isJumping) CAT.state="run";
      // Draw Cat
      CAT.x = laneX(CAT.lane);
      drawCat(CAT.x, CAT.y, CAT.state, CAT.animFrame, CAT.mood, CAT.isDucking);
      // Collisions
      let catRect = {
        x: CAT.x+9, y: CAT.y+(CAT.isDucking?16:0),
        width: CAT.width-16, height: CAT.isDucking?28:CAT.height-9
      };
      let hit = null;
      for (let ob of OBSTACLES) {
        let obRect = {x:ob.x,y:ob.y,width:ob.width,height:getObstacleHeight(ob.type)};
        if (rectIntersect(catRect,obRect)) { hit=ob; break; }
      }
      if (hit) {
        GAME.running=false; CAT.canControl=false; CAT.state="hurt";
        drawCat(CAT.x,CAT.y,"hurt",CAT.animFrame,"sad",CAT.isDucking);
        setTimeout(()=>{
          showOverlay("Game Over",`
            <b>Score:</b> ${Math.floor(GAME.score)}<br>
            <b>Best:</b> ${Math.floor(GAME.highscore)}<br>
            <br>
            <small>Swipe or tap to switch lanes/jump.<br>Feed, Pet, Sleep for advantages.<br>Avoid obstacles, collect sushi!</small>
          `);
        }, 650);
        return;
      }
      // Food powerup
      if (GAME.foodOnGround) {
        GAME.foodOnGround.x -= GAME.speed;
        drawFood(GAME.foodOnGround);
        let foodRect = { x:GAME.foodOnGround.x-12, y:GAME.foodOnGround.y-13, width:24, height:20 };
        if (rectIntersect(catRect,foodRect)) {
          STATS.hunger = Math.min(100,STATS.hunger+18);
          displayMessage("Yum! üç£","#e4a700");
          GAME.foodOnGround=null;
        }
        if (GAME.foodOnGround && GAME.foodOnGround.x<-20) GAME.foodOnGround=null;
      }
      // Score
      setScore(GAME.score+0.17*GAME.speed);
      // Spawn obstacles (multi-lane Subway Surfers style)
      if (GAME.ticks%Math.max(38,60-GAME.speed*3)===0) {
        let laneChoices = [0,1,2];
        let count = randomInt(1,2);
        for(let i=0;i<count;i++){
          let lane = laneChoices.splice(randomInt(0,laneChoices.length-1),1)[0];
          let ot = OBSTACLE_TYPES[randomInt(0,OBSTACLE_TYPES.length-1)];
          OBSTACLES.push({
            ...ot,
            x: GAME.CW+16,
            y: getObstacleY(ot.type),
            lane
          });
          OBSTACLES[OBSTACLES.length-1].x = laneX(lane);
        }
      }
      // Food bowl random spawn
      if (!GAME.foodOnGround && Math.random()<0.012) {
        let lane = randomInt(0,2);
        GAME.foodOnGround = {
          x: laneX(lane),
          y: GAME.CH-55,
          lane
        };
      }
      // BG move
      GAME.bgOffset += GAME.speed*0.92;
      // Tamagotchi Stat Decrease
      if (GAME.ticks-GAME.lastStatsTick>110) {
        GAME.lastStatsTick=GAME.ticks;
        STATS.hunger = Math.max(0,STATS.hunger-1);
        STATS.energy = Math.max(0,STATS.energy-1);
        if (GAME.ticks%6===0) STATS.happiness = Math.max(0,STATS.happiness-1);
        updateStatsUI();
      }
      // Stat Penalties
      if (STATS.hunger<15 || STATS.energy<15) {
        CAT.mood="tired";
        displayMessage("I'm tired or hungry!","#b71c1c",1800);
        GAME.speed=Math.max(4,GAME.speed-1.5);
      } else if (STATS.happiness<20) {
        CAT.mood="sad";
        displayMessage("Pet me, please!","#b23a48",1100);
      } else if (STATS.hunger>70&&STATS.energy>70&&STATS.happiness>70) {
        CAT.mood="happy";
      } else {
        CAT.mood="normal";
      }
      // Sleep state
      if (CAT.state==="sleep") {
        STATS.energy=Math.min(100,STATS.energy+1.5);
        if (STATS.energy>=100) {
          CAT.state="run"; CAT.canControl=true;
          displayMessage("Refreshed! ‚òÄÔ∏è","#4386e0",1400);
        }
      }
      // Pet
      if (GAME.petPopup>0) GAME.petPopup--;
      // Game Over if stats zero
      if (STATS.hunger<=0 || STATS.energy<=0) {
        GAME.running=false; CAT.canControl=false; CAT.state="hurt";
        drawCat(CAT.x,CAT.y,"hurt",CAT.animFrame,"sad",CAT.isDucking);
        setTimeout(()=>{
          showOverlay("Cat Collapsed!",`
            <b>Score:</b> ${Math.floor(GAME.score)}<br>
            <b>Best:</b> ${Math.floor(GAME.highscore)}<br>
            <br>
            <small>Feed and let your cat sleep to keep going!</small>
          `);
        }, 550);
        return;
      }
      requestAnimationFrame(gameLoop);
    }

    // ===== COLLISION =====
    function rectIntersect(a,b) {
      return (a.x<b.x+b.width && a.x+a.width>b.x && a.y<b.y+b.height && a.y+a.height>b.y);
    }

    // ===== CONTROLS =====
    function jump() {
      if (!CAT.canControl || CAT.isJumping || CAT.state==="sleep") return;
      CAT.vy = CAT.jumpV;
      CAT.isJumping=true;
      CAT.state="jump";
      STATS.energy = Math.max(0,STATS.energy-1.4);
      updateStatsUI();
    }
    function duck() {
      if (!CAT.canControl || CAT.state==="sleep") return;
      CAT.isDucking = true;
      CAT.state="duck";
      CAT.duckTimer = 24;
    }
    function laneSwitch(dir) {
      if (!CAT.canControl || CAT.state==="sleep") return;
      let newLane = CAT.lane+dir;
      if (newLane<0||newLane>2) return;
      CAT.lane=newLane;
      CAT.x=laneX(CAT.lane);
    }
    // Keyboard
    window.addEventListener('keydown', e=>{
      if (!CAT.canControl) return;
      if (e.code==='ArrowUp'||e.code==='Space') jump();
      else if (e.code==='ArrowDown') duck();
      else if (e.code==='ArrowLeft') laneSwitch(-1);
      else if (e.code==='ArrowRight') laneSwitch(1);
      e.preventDefault();
    },{passive:false});
    // --- MOBILE SWIPE ---
    let touchStartX=null, touchStartY=null, touchMoved=false;
    CANVAS.addEventListener('touchstart', e=>{
      if (!CAT.canControl) return;
      touchMoved=false;
      let t = e.touches[0];
      touchStartX=t.clientX; touchStartY=t.clientY;
    },{passive:false});
    CANVAS.addEventListener('touchmove', e=>{
      if (!CAT.canControl) return;
      let t = e.touches[0];
      let dx = t.clientX-touchStartX, dy = t.clientY-touchStartY;
      if (Math.abs(dx)>Math.abs(dy)&&Math.abs(dx)>26) {
        // Lane left/right
        laneSwitch(dx>0?1:-1);
        touchStartX=t.clientX; // Allow rapid switches
        touchMoved=true;
      } else if (Math.abs(dy)>Math.abs(dx)&&dy<-23) {
        jump();
        touchMoved=true;
        touchStartY=t.clientY;
      } else if (Math.abs(dy)>Math.abs(dx)&&dy>23) {
        duck();
        touchMoved=true;
        touchStartY=t.clientY;
      }
      e.preventDefault();
    },{passive:false});
    CANVAS.addEventListener('touchend', e=>{
      if (!CAT.canControl) return;
      if (!touchMoved) jump(); // Tap = jump
      touchStartX=null; touchStartY=null; touchMoved=false;
      e.preventDefault();
    },{passive:false});
    // Prevent page scroll/bounce
    document.body.addEventListener('touchmove', function(e){e.preventDefault();},{passive:false});
    document.body.addEventListener('scroll', function(e){window.scrollTo(0,0);});
    // Focus canvas
    CANVAS.addEventListener('click',()=>CANVAS.focus());

    // ===== BUTTONS =====
    document.getElementById('feedBtn').onclick=()=>{
      if (!GAME.running||!CAT.canControl) return;
      if (STATS.hunger>95) {displayMessage("I'm full!");return;}
      STATS.hunger=Math.min(100,STATS.hunger+23);
      updateStatsUI();
      displayMessage("Fed! üç£","#e4a700");
      STATS.happiness=Math.min(100,STATS.happiness+8);
      STATS.energy=Math.min(100,STATS.energy+3);
    };
    document.getElementById('petBtn').onclick=()=>{
      if (!GAME.running||!CAT.canControl) return;
      STATS.happiness=Math.min(100,STATS.happiness+11);
      updateStatsUI();
      displayMessage("Purr... üêæ","#fa9bb2");
      GAME.petPopup=38;
    };
    document.getElementById('sleepBtn').onclick=()=>{
      if (!GAME.running||!CAT.canControl) return;
      if (CAT.state==="sleep") {displayMessage("Already sleeping!");return;}
      if (STATS.energy>65) {displayMessage("Not sleepy yet.");return;}
      CAT.state="sleep"; CAT.canControl=false;
      displayMessage("Zzz... üò¥","#4386e0",1700);
    };
    document.getElementById('restartBtn').onclick=()=>{
      resetGame();
      requestAnimationFrame(gameLoop);
    };
    // ===== PERSISTENCE =====
    let hs=+localStorage.getItem('catsurfers_highscore');
    if (!isNaN(hs)) {
      GAME.highscore=hs;
      document.getElementById('highscore').textContent="Best: "+Math.floor(GAME.highscore);
    }
    // ===== INIT =====
    updateStatsUI(); setScore(0);
    fitCanvas();
    showOverlay("Cat Surfers",`
      <b>How to play:</b><br>
      <ul style="text-align:left;font-size:0.99em;margin:8px 0 0 28px;">
        <li>Swipe or tap to jump.</li>
        <li>Swipe down to duck.</li>
        <li>Swipe left/right to change lanes.</li>
        <li>Use <b>Feed</b>, <b>Pet</b>, <b>Sleep</b> for bonuses.</li>
        <li>Avoid obstacles, collect food, keep stats high!</li>
      </ul>
      <br>
      <small>Press <b>Start</b> to begin.</small>
    `);
    document.getElementById('overlay').addEventListener('click',e=>{
      if (e.target===document.getElementById('overlay')) {
        hideOverlay();
        resetGame();
        requestAnimationFrame(gameLoop);
      }
    });
    // Prevent accidental page scroll (esp. on iOS)
    window.scrollTo(0,0);
    window.addEventListener('resize', fitCanvas);
    // Prevent double-tap zoom
    let lastTouch=0;
    document.body.addEventListener('touchend',function(e){
      let now=new Date().getTime();
      if(now-lastTouch<=300){e.preventDefault();}
      lastTouch=now;
    },{passive:false});
  </script>
</body>
</html>
