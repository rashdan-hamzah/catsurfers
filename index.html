<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Ninja Neko</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no,maximum-scale=1.0">
  <style>
    html, body {
      margin: 0; padding: 0;
      background: #232942;
      font-family: 'Segoe UI', Arial, sans-serif;
      user-select: none;
      -webkit-user-select: none;
      overflow: hidden;
      touch-action: none;
      overscroll-behavior: none;
      height: 100%;
      width: 100vw;
      min-height: 100vh;
    }
    body {
      width: 100vw; min-height: 100vh; height: 100vh;
    }
    #game-container {
      width: 100vw;
      height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      position: relative;
      overflow: hidden;
      background: #232942;
    }
    #gameCanvas {
      display: block;
      background: transparent;
      margin: 0 auto;
      border-radius: 14px;
      margin-top: 0;
      touch-action: none;
      -webkit-user-select: none;
      user-select: none;
    }
    #scoreboard {
      position: absolute;
      top: 10px; left: 0; right: 0;
      width: 100vw;
      display: flex;
      justify-content: space-between;
      padding: 0 30px;
      font-size: 1.35em;
      font-weight: bold;
      color: #fffbe0;
      letter-spacing: 0.5px;
      text-shadow: 2px 2px 6px #29292955;
      z-index: 11;
      pointer-events: none;
    }
    #stats {
      position: absolute;
      top: 54px;
      left: 0; right: 0;
      width: 100vw;
      display: flex;
      gap: 30px;
      justify-content: center;
      font-size: 1em;
      font-weight: 600;
      color: #245073;
      letter-spacing: 1px;
      z-index: 11;
      pointer-events: none;
      filter: drop-shadow(0 3px 2px #fff7);
    }
    .stat-bar {
      width: 70px;
      height: 9px;
      border-radius: 5px;
      background: #313f42;
      margin-left: 6px;
      display: inline-block;
      vertical-align: middle;
      overflow: hidden;
      position: relative;
    }
    .bar-inner { height: 100%; border-radius: 5px; transition: width 0.3s; position: absolute; left: 0; top: 0; }
    .hunger-bar { background: linear-gradient(90deg, #fff47c, #f1b80c); }
    .happiness-bar { background: linear-gradient(90deg, #45ecc8, #169e6e); }
    .energy-bar { background: linear-gradient(90deg, #b1e0ff, #2066b0); }
    #controls {
      position: absolute;
      bottom: 44px;
      left: 0; right: 0;
      display: flex;
      gap: 12px;
      justify-content: center;
      z-index: 14;
    }
    #controls button {
      font-size: 1.07em;
      border: none;
      border-radius: 10px;
      background: #fff5c6;
      color: #564200;
      padding: 9px 17px;
      cursor: pointer;
      font-weight: 650;
      box-shadow: 0 4px 13px rgba(0,0,0,0.09);
      transition: background 0.14s, color 0.14s;
      outline: none;
    }
    #controls button:disabled {
      background: #e0cba0;
      color: #a7a7a7;
      cursor: not-allowed;
    }
    #controls button:hover, #controls button:focus {
      background: #ffe35e;
      color: #c15800;
    }
    #message {
      position: absolute;
      top: 87px; left: 0; right: 0;
      text-align: center;
      font-size: 1.10em;
      color: #f8e98c;
      font-weight: 650;
      letter-spacing: 1px;
      min-height: 18px;
      z-index: 13;
      pointer-events: none;
      text-shadow: 0 1px 4px #21213b;
    }
    #overlay {
      display: none;
      position: fixed;
      left: 0; top: 0; right: 0; bottom: 0;
      background: rgba(36, 44, 66, 0.20);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }
    #overlay.active {
      display: flex;
    }
    #overlay-content {
      background: #232942;
      border-radius: 18px;
      box-shadow: 0 4px 22px #0002;
      padding: 36px 25px 22px 25px;
      text-align: center;
      min-width: 230px;
      max-width: 95vw;
      color: #f8e98c;
    }
    #overlay-content h2 { margin: 0 0 16px 0; color: #f8e98c; }
    #overlay-content p { margin: 0 0 16px 0; color: #fffbe0; font-size: 1.11em; }
    #overlay-content button {
      margin-top: 13px;
      font-size: 1.09em;
      background: #45ecc8;
      color: #145a31;
      border: none;
      border-radius: 8px;
      padding: 9px 24px;
      font-weight: 700;
      cursor: pointer;
      transition: background 0.1s;
    }
    #overlay-content button:hover { background: #169e6e; color: #fff; }
    @media (max-width: 600px) {
      #gameCanvas { width: 100vw !important; height: 59vw !important; }
      #scoreboard, #stats { font-size: 0.95em; padding: 0 9vw; }
      .stat-bar { width: 36vw; max-width: 70px; }
    }
    /* Storyline full screen overlay */
    #storyline {
      position: absolute;
      left: 0; right: 0; top: 0; bottom: 0;
      z-index: 2000;
      width: 100vw; height: 100vh;
      background: radial-gradient(ellipse at center, #10182b 80%, #232942 100%);
      display: none;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      overflow: hidden;
    }
    #storyline.active {
      display: flex;
      animation: fadeIn 0.7s;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    #story-canvas {
      width: 100vw;
      max-width: 420px;
      height: 72vw;
      max-height: 340px;
      background: transparent;
      display: block;
    }
    #story-text {
      color: #ffe35e;
      font-size: 1.15em;
      text-align: center;
      margin: 18px auto 0 auto;
      width: 90vw;
      max-width: 420px;
      min-height: 70px;
      font-weight: 600;
      text-shadow: 2px 2px 14px #23294299;
    }
    #story-btn {
      margin-top: 16px;
      font-size: 1.08em;
      background: #fa9bb2;
      color: #3a1526;
      border: none;
      border-radius: 8px;
      padding: 10px 28px;
      font-weight: 700;
      cursor: pointer;
      transition: background 0.11s;
      box-shadow: 0 3px 18px #0002;
    }
    #story-btn:hover { background: #d36782; color: #fff; }
  </style>
</head>
<body>
  <div id="game-container">
    <div id="scoreboard">
      <span id="score">0</span>
      <span id="highscore">Best: 0</span>
    </div>
    <canvas id="gameCanvas" width="420" height="620" tabindex="0"></canvas>
    <div id="stats">
      <span>
        <span style="font-size:1.05em">üç£</span>
        <span class="stat-bar"><span class="bar-inner hunger-bar" id="hunger-bar"></span></span>
      </span>
      <span>
        <span style="font-size:1.05em">üò∫</span>
        <span class="stat-bar"><span class="bar-inner happiness-bar" id="happiness-bar"></span></span>
      </span>
      <span>
        <span style="font-size:1.05em">‚ö°Ô∏è</span>
        <span class="stat-bar"><span class="bar-inner energy-bar" id="energy-bar"></span></span>
      </span>
    </div>
    <div id="controls">
      <button id="feedBtn">üç£ Feed</button>
      <button id="petBtn">üêæ Pet</button>
      <button id="sleepBtn">üò¥ Sleep</button>
    </div>
    <div id="message"></div>
    <div id="overlay">
      <div id="overlay-content">
        <h2 id="overlay-title"></h2>
        <p id="overlay-msg"></p>
        <button id="restartBtn">Start</button>
      </div>
    </div>
    <div id="storyline">
      <canvas id="story-canvas" width="420" height="340"></canvas>
      <div id="story-text"></div>
      <button id="story-btn">Continue</button>
    </div>
  </div>
  <script>
  // ===== VISUALS & GAME DIMENSIONS =====
  const CANVAS = document.getElementById('gameCanvas');
  const CTX = CANVAS.getContext('2d');
  function fitCanvas() {
    const w = window.innerWidth, h = window.innerHeight;
    let cw = Math.min(420, w, h*0.68), ch = Math.round(cw*1.45);
    CANVAS.width = cw;
    CANVAS.height = ch;
    CANVAS.style.width = cw + "px";
    CANVAS.style.height = ch + "px";
    GAME.CW = cw; GAME.CH = ch;
  }
  // ===== CAT & GAME CONSTANTS =====
  const LANES = [0, 1, 2];
  const COLORS = {
    sky: ["#232942", "#494e8c"],
    sunset: ["#ffb964", "#8430a0"],
    night: ["#232942", "#111828"],
    ground: "#2b3049",
    road: "#353c67",
    side: "#3a344c"
  };
  const CAT = {
    lane: 1,
    x: 0, y: 0, vy: 0,
    width: 56, height: 56,
    jumpV: -13.8,
    isJumping: false,
    isDucking: false,
    duckTimer: 0,
    animFrame: 0,
    animTick: 0,
    state: "run", // run, jump, duck, hurt, sleep
    mood: "normal", // happy, normal, sad, tired, sleepy
    canControl: false // true after story
  };
  // Tamagotchi Stats
  const STATS = { hunger: 100, happiness: 100, energy: 100 };
  // Game State
  let GAME = {
    running: false,
    gameover: false,
    paused: false,
    score: 0,
    highscore: 0,
    speed: 8,
    lanes: 3,
    laneY: 0,
    groundY: 0,
    bgOffset: 0,
    ticks: 0,
    lastStatsTick: 0,
    foodOnGround: null,
    petPopup: 0,
    theme: "night",
    CW: 420,
    CH: 620
  };
  // Obstacles
  const OBSTACLES = [];
  const OBSTACLE_TYPES = [
    { type:"crate", width:52, height:52, lane:1, color:"#6b4a1f" },
    { type:"cat-guard", width:54, height:52, lane:0, color:"#443a31" },
    { type:"yarn", width:38, height:38, lane:2, color:"#fa9bb2" },
    { type:"kunai", width:28, height:20, lane:0, color:"#b1e0ff" },
    { type:"cone", width:32, height:38, lane:2, color:"#ffa34c" }
  ];

  // ====== UTILITIES & UI ======
  function setStatBar(bar, value) {
    bar.style.width = `${Math.max(0, Math.min(100, value))}%`;
  }
  function updateStatsUI() {
    setStatBar(document.getElementById('hunger-bar'), STATS.hunger);
    setStatBar(document.getElementById('happiness-bar'), STATS.happiness);
    setStatBar(document.getElementById('energy-bar'), STATS.energy);
  }
  function displayMessage(msg, color="#f8e98c", duration=1400) {
    let el = document.getElementById('message');
    el.textContent = msg;
    el.style.color = color;
    if (GAME.msgTimeout) clearTimeout(GAME.msgTimeout);
    if (duration>0) GAME.msgTimeout = setTimeout(()=>{el.textContent="";},duration);
  }
  function setScore(val) {
    GAME.score = val;
    document.getElementById('score').textContent = Math.floor(GAME.score);
    if (GAME.score > GAME.highscore) {
      GAME.highscore = GAME.score;
      document.getElementById('highscore').textContent = "Best: " + Math.floor(GAME.highscore);
      localStorage.setItem('ninjacatsurfers_highscore', GAME.highscore);
    }
  }
  function setTheme(theme) {
    GAME.theme = theme;
    let [c1,c2] = COLORS[theme==="night"?"sky":theme];
    document.getElementById('game-container').style.background =
        `linear-gradient(180deg, ${c1} 80%, ${c2} 99%)`;
  }
  function randomInt(a,b){return Math.floor(Math.random()*(b-a+1))+a;}
  function laneX(lane) {
    let pad = GAME.CW * 0.13;
    let laneW = (GAME.CW - pad*2) / (GAME.lanes-1);
    return pad + lane*laneW - CAT.width/2;
  }
  function getLaneY() {
    return GAME.CH - 106;
  }
  function getObstacleY(type) {
    if (type==="crate"||type==="cat-guard"||type==="cone"||type==="yarn") return -60;
    if (type==="kunai") return -34;
    return -60;
  }
  function getObstacleHeight(type) {
    if (type==="kunai") return 20;
    if (type==="cone"||type==="yarn") return 38;
    return 52;
  }

  // ===== MAIN GAME LOGIC =====
  function resetGame(full=true) {
    GAME.running = true;
    GAME.gameover = false;
    GAME.score = 0;
    GAME.speed = 8;
    GAME.bgOffset = 0;
    GAME.ticks = 0;
    GAME.lastStatsTick = 0;
    GAME.foodOnGround = null;
    OBSTACLES.length = 0;
    setTheme("night");
    CAT.lane = 1;
    CAT.x = laneX(1);
    CAT.y = getLaneY();
    CAT.vy = 0;
    CAT.isJumping = false;
    CAT.isDucking = false;
    CAT.duckTimer = 0;
    CAT.state = "run";
    CAT.animFrame = 0;
    CAT.animTick = 0;
    CAT.mood = "normal";
    CAT.canControl = true;
    updateStatsUI();
    setScore(0);
    if (full) STATS.hunger=100,STATS.happiness=100,STATS.energy=100;
    hideOverlay();
  }
  function showOverlay(title, msg) {
    document.getElementById('overlay').classList.add('active');
    document.getElementById('overlay-title').textContent = title;
    document.getElementById('overlay-msg').innerHTML = msg;
    document.getElementById('restartBtn').focus();
    GAME.running = false;
  }
  function hideOverlay() {
    document.getElementById('overlay').classList.remove('active');
  }

  // ===== CAT DRAWING (NINJA VIBES) =====
  function drawCat(x, y, state, frame, mood, isDucking) {
    CTX.save();
    // Shadow
    CTX.globalAlpha = 0.18;
    CTX.beginPath();
    CTX.ellipse(x+CAT.width/2, y+CAT.height-8, isDucking?23:29, 9, 0, 0, 2*Math.PI);
    CTX.fillStyle="#1f2439";
    CTX.fill();
    CTX.globalAlpha = 1;
    // Main
    CTX.save();
    CTX.translate(x,y);
    if (isDucking) CTX.translate(0, 16);
    // Tail
    let tailSwing = (state==="run"||state==="jump")?Math.sin(frame/1.5)*11:0;
    CTX.strokeStyle="#474d71";
    CTX.lineWidth=7;
    CTX.beginPath();
    CTX.moveTo(48,44);
    CTX.quadraticCurveTo(66+tailSwing,24+tailSwing,40,9+(state==="jump"?12:0));
    CTX.stroke();
    // Body (ninja suit)
    CTX.fillStyle="#232942";
    CTX.beginPath();
    CTX.ellipse(28,36,24,18,0,0,2*Math.PI);
    CTX.fill();
    // Belt
    CTX.fillStyle="#b21f2d";
    CTX.fillRect(10,48,36,7);
    // Legs
    let lw=isDucking?14:11,lh=isDucking?10:18;
    let lY=isDucking?42:53;
    let legMove = (state==="run")?Math.sin(frame/1.5)*8:0;
    CTX.fillStyle="#343c5a";
    CTX.fillRect(13+legMove,lY,lw,lh);
    CTX.fillRect(32-legMove,lY,lw,lh);
    // Head
    CTX.save();
    let headTilt=(state==="jump")?-0.14:(state==="duck"?0.10:0);
    CTX.translate(29,12); CTX.rotate(headTilt); CTX.translate(-29,-12);
    // Ears
    CTX.beginPath();
    CTX.moveTo(9,17); CTX.lineTo(20,1); CTX.lineTo(26,17); CTX.closePath();
    CTX.fillStyle="#424c6e"; CTX.fill();
    CTX.beginPath();
    CTX.moveTo(48,17); CTX.lineTo(37,1); CTX.lineTo(32,17); CTX.closePath();
    CTX.fill();
    // Face (ninja mask)
    CTX.beginPath();
    CTX.ellipse(29,21,16,13.5,0,0,2*Math.PI);
    CTX.fillStyle="#353c67";
    CTX.fill();
    // Mask wrap
    CTX.beginPath();
    CTX.ellipse(29,21,15,11,0,0,2*Math.PI);
    CTX.fillStyle="#232942";
    CTX.fill();
    // Mask cheeks (ninja color)
    if (mood==="happy") {
      CTX.beginPath();
      CTX.arc(17,28,4,0,2*Math.PI);
      CTX.arc(41,28,4,0,2*Math.PI);
      CTX.fillStyle="#fa9bb2";
      CTX.globalAlpha = 0.36+0.28*Math.abs(Math.sin(frame/1.5));
      CTX.fill(); CTX.globalAlpha=1.0;
    }
    // Eyes
    CTX.fillStyle="#ffe35e";
    if (state==="sleep") {
      CTX.beginPath();
      CTX.arc(20,24,4,Math.PI*0.2,Math.PI*0.8);
      CTX.arc(38,24,4,Math.PI*0.2,Math.PI*0.8);
      CTX.strokeStyle="#ffe35e"; CTX.lineWidth=2; CTX.stroke();
    } else if (mood==="happy") {
      CTX.beginPath();
      CTX.arc(20,24,3.8,0,2*Math.PI);
      CTX.arc(38,24,3.8,0,2*Math.PI);
      CTX.fill();
      CTX.fillStyle="#fff";
      CTX.beginPath();
      CTX.arc(21.8,23,1.1,0,2*Math.PI);
      CTX.arc(39.8,23,1.1,0,2*Math.PI);
      CTX.fill();
    } else if (mood==="sad") {
      CTX.beginPath();
      CTX.arc(20,27,2.5,Math.PI*1.2,0,false);
      CTX.arc(38,27,2.5,Math.PI,Math.PI*1.8,false);
      CTX.strokeStyle="#ffe35e"; CTX.lineWidth=2; CTX.stroke();
    } else {
      let blink = (frame%34===21)?0.8:3.8;
      CTX.beginPath();
      CTX.arc(20,24,blink,0,2*Math.PI);
      CTX.arc(38,24,blink,0,2*Math.PI);
      CTX.fill();
      if (blink>1.5) {
        CTX.fillStyle="#fff";
        CTX.beginPath();
        CTX.arc(21.8,23,1.1,0,2*Math.PI);
        CTX.arc(39.8,23,1.1,0,2*Math.PI);
        CTX.fill();
      }
    }
    // Ninja bandana
    CTX.save();
    CTX.translate(10,17);
    CTX.rotate(-0.6+Math.sin(frame/11)*0.12);
    CTX.fillStyle="#b21f2d";
    CTX.fillRect(0,0,14,3.5);
    CTX.restore();
    // Nose
    CTX.beginPath();
    CTX.moveTo(29,29); CTX.lineTo(27.8,30.5); CTX.lineTo(30.2,30.5); CTX.closePath();
    CTX.fillStyle="#e38b5d";
    CTX.fill();
    // Mouth
    CTX.beginPath();
    if (state==="sleep") {} else if (mood==="happy") {
      CTX.arc(29,33,3,0,Math.PI,false);
    } else if (mood==="sad") {
      CTX.arc(29,35,3,Math.PI,2*Math.PI,true);
    } else {
      CTX.arc(29,34,2.2,0,Math.PI,false);
    }
    CTX.strokeStyle="#ffe35e"; CTX.lineWidth=1.2;
    CTX.stroke();
    CTX.restore();
    // Pet popup
    if (GAME.petPopup>0) drawHeart(x+29,y-16-GAME.petPopup*0.5);
    // Zzz (sleep)
    if (state==="sleep") drawZzz(x+42,y-7);
    CTX.restore();
    CTX.restore();
  }
  function drawZzz(x,y){
    CTX.save();
    CTX.font="bold 19px Arial";
    CTX.fillStyle="#ffe35e";
    CTX.globalAlpha=0.7;
    CTX.fillText("Z",x,y);
    CTX.font="bold 13px Arial";
    CTX.fillText("z",x+12,y-12);
    CTX.globalAlpha=1.0; CTX.restore();
  }
  function drawHeart(x,y) {
    CTX.save();
    CTX.beginPath();
    CTX.moveTo(x,y);
    CTX.bezierCurveTo(x,y-7,x-11,y-7,x-11,y);
    CTX.bezierCurveTo(x-11,y+9,x,y+15,x,y+19);
    CTX.bezierCurveTo(x,y+15,x+11,y+9,x+11,y);
    CTX.bezierCurveTo(x+11,y-7,x,y-7,x,y);
    CTX.fillStyle="#fa9bb2";
    CTX.globalAlpha=0.8; CTX.fill();
    CTX.restore();
  }
  // ===== OBSTACLE DRAWING =====
  function drawObstacle(ob) {
    CTX.save();
    let {x,y,type,width,height,color}=ob;
    if (type==="crate") {
      CTX.fillStyle=color;
      CTX.fillRect(x,y,width,height);
      CTX.strokeStyle="#4e2c11"; CTX.lineWidth=3;
      CTX.strokeRect(x+2,y+2,width-4,height-4);
    } else if (type==="cat-guard") {
      // Cat guard (ninja style)
      CTX.save();
      CTX.translate(x,y);
      // Body
      CTX.fillStyle="#3f2e2a";
      CTX.beginPath();
      CTX.ellipse(width/2,height-13,width/2.5,17,0,0,2*Math.PI);
      CTX.fill();
      // Head
      CTX.fillStyle="#2a1f1a";
      CTX.beginPath();
      CTX.ellipse(width/2,20,15,13,0,0,2*Math.PI);
      CTX.fill();
      // Eyes (angry)
      CTX.fillStyle="#ffe35e";
      CTX.fillRect(width/2-6,23,3,3);
      CTX.fillRect(width/2+3,23,3,3);
      // Ninja bandana
      CTX.fillStyle="#b21f2d";
      CTX.fillRect(width/2-14,13,28,7);
      // Ears
      CTX.beginPath();
      CTX.moveTo(10,10); CTX.lineTo(15,0); CTX.lineTo(18,14); CTX.closePath();
      CTX.fillStyle="#42312a"; CTX.fill();
      CTX.beginPath();
      CTX.moveTo(38,10); CTX.lineTo(33,0); CTX.lineTo(30,14); CTX.closePath();
      CTX.fill();
      CTX.restore();
    } else if (type==="yarn") {
      CTX.beginPath();
      CTX.arc(x+width/2,y+height/2,width/2,0,2*Math.PI);
      CTX.fillStyle=color; CTX.fill();
      CTX.strokeStyle="#b23a48";
      CTX.lineWidth=1;
      for(let i=0;i<3;i++){
        CTX.beginPath();
        CTX.arc(x+width/2,y+height/2,width/2-2,i*0.7,i*0.7+1);
        CTX.stroke();
      }
      CTX.beginPath();
      CTX.moveTo(x+width/2+7,y+height/2+7);
      CTX.bezierCurveTo(x+width+6,y+height+7,x+width+10,y+height/2+18,x+width+12,y+height/2+19);
      CTX.stroke();
    } else if (type==="kunai") {
      CTX.save();
      CTX.translate(x+width/2,y+height/2);
      CTX.rotate(Math.PI*0.1+Math.sin(GAME.ticks/12)*0.09);
      CTX.beginPath();
      CTX.moveTo(0,-10); CTX.lineTo(6,0); CTX.lineTo(0,10); CTX.lineTo(-6,0); CTX.closePath();
      CTX.fillStyle=color; CTX.fill();
      CTX.strokeStyle="#1e2b39"; CTX.lineWidth=2; CTX.stroke();
      CTX.restore();
    } else if (type==="cone") {
      CTX.save();
      CTX.beginPath();
      CTX.moveTo(x+width/2,y);
      CTX.lineTo(x+width,y+height);
      CTX.lineTo(x,y+height);
      CTX.closePath();
      CTX.fillStyle=color; CTX.fill();
      CTX.strokeStyle="#ec950c"; CTX.stroke();
      CTX.restore();
    }
    CTX.restore();
  }
  // ===== GROUND, BG, DECOR =====
  function drawGround(offset) {
    CTX.save();
    // Sidewalk stripes (ninja city night)
    for(let i=0;i<10;i++) {
      let x=(i*110-(offset%110));
      CTX.fillStyle=COLORS.side;
      CTX.fillRect(x,GAME.CH-59,70,14);
      CTX.strokeStyle="#434373"; CTX.lineWidth=2;
      CTX.strokeRect(x+5,GAME.CH-59,60,14);
    }
    // Main road
    CTX.fillStyle=COLORS.road;
    CTX.fillRect(0,GAME.CH-112,GAME.CW,53);
    // Main ground
    CTX.fillStyle=COLORS.ground;
    CTX.fillRect(0,GAME.CH-59,GAME.CW,59);
    CTX.restore();
  }
  function drawBackground(offset) {
    // BG: ninja cityscape
    let theme = GAME.theme;
    if (theme==="night") {
      CTX.save();
      CTX.globalAlpha=0.7;
      CTX.beginPath();
      CTX.arc(60,60,23,0,2*Math.PI);
      CTX.fillStyle="#ffe35e"; CTX.fill();
      // Stars
      for(let i=0;i<15;i++){
        CTX.save();
        CTX.globalAlpha=0.5+0.5*Math.sin(GAME.ticks/60+i*2);
        CTX.beginPath();
        CTX.arc((i*27+offset*0.3)%GAME.CW,40+(i%3)*12,1.2,0,2*Math.PI);
        CTX.fillStyle="#fff"; CTX.fill();
        CTX.restore();
      }
      CTX.restore();
    }
    // Distant cityscape
    for(let i=0;i<5;i++){
      let x=(i*120-(offset%240));
      CTX.fillStyle=theme==="night"?"#2e3750":"#b0b9c6";
      CTX.fillRect(x,GAME.CH-220,68,68+randomInt(-6,14));
    }
    // Pagoda rooftops
    for(let i=0;i<2;i++){
      let px=(i*240-(offset%480))+80;
      CTX.save();
      CTX.fillStyle="#e4a700";
      CTX.fillRect(px,GAME.CH-180,70,10);
      CTX.restore();
    }
    // Neon clouds
    for(let i=0;i<4;i++){
      let cx=(i*120-(offset%480))+60;
      let cy=38+(i%2)*9;
      CTX.save();
      CTX.globalAlpha=0.19+0.13*(Math.sin(GAME.ticks/60+i)+1);
      CTX.beginPath();
      CTX.ellipse(cx,cy,36,12,0,0,2*Math.PI);
      CTX.fillStyle=theme==="night"?"#a0a8ff":"#fff";
      CTX.fill();
      CTX.restore();
    }
  }
  // ===== POWERUP FOOD =====
  function drawFood(food) {
    if (!food) return;
    CTX.save();
    CTX.translate(food.x, food.y);
    CTX.fillStyle="#fff47c";
    CTX.beginPath();
    CTX.ellipse(0,0,19,10,0,0,2*Math.PI);
    CTX.fill();
    CTX.strokeStyle="#e4a700"; CTX.stroke();
    CTX.beginPath();
    CTX.ellipse(0,-3,8,4,0,0,2*Math.PI);
    CTX.fillStyle="#e4a700"; CTX.globalAlpha=0.8; CTX.fill();
    CTX.globalAlpha=1;
    CTX.restore();
  }
  // ===== MAIN GAME LOOP =====
  function gameLoop() {
    if (!GAME.running) return;
    fitCanvas();
    CTX.clearRect(0,0,GAME.CW,GAME.CH);
    GAME.ticks++;
    // Theme switch for vibes
    if (GAME.score>0 && Math.floor(GAME.score)%350===0 && Math.floor(GAME.score)!==0) {
      if (GAME.theme==="night") setTheme("sunset");
      else if (GAME.theme==="sunset") setTheme("sky");
      else setTheme("night");
    }
    // Update speed
    GAME.speed = 8+Math.floor(GAME.score/200);
    // BG
    drawBackground(GAME.bgOffset);
    // GROUND
    drawGround(GAME.bgOffset);
    // Obstacles
    for (let i=OBSTACLES.length-1;i>=0;i--) {
      let ob=OBSTACLES[i];
      ob.y += GAME.speed;
      drawObstacle(ob);
      if (ob.y>GAME.CH+60) OBSTACLES.splice(i,1);
    }
    // Cat
    CAT.animTick++;
    if (CAT.animTick%4===0) CAT.animFrame++;
    // Apply gravity
    if (!CAT.isJumping && CAT.y<getLaneY()) {
      CAT.y = getLaneY(); CAT.vy=0; CAT.state="run";
    }
    if (CAT.isJumping) {
      CAT.vy += 0.75;
      CAT.y += CAT.vy;
      if (CAT.y>=getLaneY()) {
        CAT.y=getLaneY(); CAT.vy=0; CAT.isJumping=false; CAT.state="run";
      }
    }
    if (CAT.isDucking) {
      CAT.state="duck";
      CAT.duckTimer--;
      if (CAT.duckTimer<=0) { CAT.isDucking=false; CAT.state="run"; }
    } else if (!CAT.isJumping) CAT.state="run";
    // Draw Cat
    CAT.x = laneX(CAT.lane);
    drawCat(CAT.x, CAT.y, CAT.state, CAT.animFrame, CAT.mood, CAT.isDucking);
    // Collisions
    let catRect = {
      x: CAT.x+10, y: CAT.y+(CAT.isDucking?20:0),
      width: CAT.width-18, height: CAT.isDucking?28:CAT.height-14
    };
    let hit = null;
    for (let ob of OBSTACLES) {
      let obRect = {x:ob.x,y:ob.y,width:ob.width,height:getObstacleHeight(ob.type)};
      if (rectIntersect(catRect,obRect)) { hit=ob; break; }
    }
    if (hit) {
      GAME.running=false; CAT.canControl=false; CAT.state="hurt";
      drawCat(CAT.x,CAT.y,"hurt",CAT.animFrame,"sad",CAT.isDucking);
      setTimeout(()=>{
        showOverlay("Caught by Cat Guard!",`
          <b>Score:</b> ${Math.floor(GAME.score)}<br>
          <b>Best:</b> ${Math.floor(GAME.highscore)}<br>
          <br>
          <small>Swipe or tap to switch lanes/jump.<br>Feed, Pet, Sleep for bonuses.<br>Stay ahead, avoid cat-guards!</small>
        `);
      }, 650);
      return;
    }
    // Food powerup
    if (GAME.foodOnGround) {
      GAME.foodOnGround.y += GAME.speed;
      drawFood(GAME.foodOnGround);
      let foodRect = { x:GAME.foodOnGround.x-13, y:GAME.foodOnGround.y-13, width:26, height:20 };
      if (rectIntersect(catRect,foodRect)) {
        STATS.hunger = Math.min(100,STATS.hunger+19);
        displayMessage("Ninja Sushi! üç£","#e4a700");
        GAME.foodOnGround=null;
      }
      if (GAME.foodOnGround && GAME.foodOnGround.y>GAME.CH+22) GAME.foodOnGround=null;
    }
    // Score
    setScore(GAME.score+0.22*GAME.speed);
    // Spawn obstacles (multi-lane)
    if (GAME.ticks%Math.max(34,52-GAME.speed*3)===0) {
      let laneChoices = [0,1,2];
      let count = randomInt(1,2);
      for(let i=0;i<count;i++){
        let lane = laneChoices.splice(randomInt(0,laneChoices.length-1),1)[0];
        let ot = OBSTACLE_TYPES[randomInt(0,OBSTACLE_TYPES.length-1)];
        OBSTACLES.push({
          ...ot,
          y: getObstacleY(ot.type),
          x: laneX(lane),
          lane
        });
      }
    }
    // Food bowl random spawn
    if (!GAME.foodOnGround && Math.random()<0.012) {
      let lane = randomInt(0,2);
      GAME.foodOnGround = {
        x: laneX(lane)+16,
        y: -30,
        lane
      };
    }
    // BG move
    GAME.bgOffset += GAME.speed*0.92;
    // Tamagotchi Stat Decrease
    if (GAME.ticks-GAME.lastStatsTick>110) {
      GAME.lastStatsTick=GAME.ticks;
      STATS.hunger = Math.max(0,STATS.hunger-1);
      STATS.energy = Math.max(0,STATS.energy-1);
      if (GAME.ticks%6===0) STATS.happiness = Math.max(0,STATS.happiness-1);
      updateStatsUI();
    }
    // Stat Penalties
    if (STATS.hunger<15 || STATS.energy<15) {
      CAT.mood="tired";
      displayMessage("Ninja cat is tired or hungry!","#ffe35e",1800);
      GAME.speed=Math.max(5,GAME.speed-2.2);
    } else if (STATS.happiness<20) {
      CAT.mood="sad";
      displayMessage("Pet me, ninja friend!","#fa9bb2",1200);
    } else if (STATS.hunger>70&&STATS.energy>70&&STATS.happiness>70) {
      CAT.mood="happy";
    } else {
      CAT.mood="normal";
    }
    // Sleep state
    if (CAT.state==="sleep") {
      STATS.energy=Math.min(100,STATS.energy+1.7);
      if (STATS.energy>=100) {
        CAT.state="run"; CAT.canControl=true;
        displayMessage("Ninja's mind is sharp! ‚òÄÔ∏è","#ffe35e",1400);
      }
    }
    // Pet
    if (GAME.petPopup>0) GAME.petPopup--;
    // Game Over if stats zero
    if (STATS.hunger<=0 || STATS.energy<=0) {
      GAME.running=false; CAT.canControl=false; CAT.state="hurt";
      drawCat(CAT.x,CAT.y,"hurt",CAT.animFrame,"sad",CAT.isDucking);
      setTimeout(()=>{
        showOverlay("Ninja Cat Fainted!",`
          <b>Score:</b> ${Math.floor(GAME.score)}<br>
          <b>Best:</b> ${Math.floor(GAME.highscore)}<br>
          <br>
          <small>Feed and let your ninja cat sleep to keep going!</small>
        `);
      }, 550);
      return;
    }
    requestAnimationFrame(gameLoop);
  }

  // ===== COLLISION =====
  function rectIntersect(a,b) {
    return (a.x<b.x+b.width && a.x+a.width>b.x && a.y<b.y+b.height && a.y+a.height>b.y);
  }

  // ===== CONTROLS =====
  function jump() {
    if (!CAT.canControl || CAT.isJumping || CAT.state==="sleep") return;
    CAT.vy = CAT.jumpV;
    CAT.isJumping=true;
    CAT.state="jump";
    STATS.energy = Math.max(0,STATS.energy-1.6);
    updateStatsUI();
  }
  function duck() {
    if (!CAT.canControl || CAT.state==="sleep") return;
    CAT.isDucking = true;
    CAT.state="duck";
    CAT.duckTimer = 25;
  }
  function laneSwitch(dir) {
    if (!CAT.canControl || CAT.state==="sleep") return;
    let newLane = CAT.lane+dir;
    if (newLane<0||newLane>2) return;
    CAT.lane=newLane;
    CAT.x=laneX(CAT.lane);
  }
  // Keyboard
  window.addEventListener('keydown', e=>{
    if (!CAT.canControl) return;
    if (e.code==='ArrowUp'||e.code==='Space') jump();
    else if (e.code==='ArrowDown') duck();
    else if (e.code==='ArrowLeft') laneSwitch(-1);
    else if (e.code==='ArrowRight') laneSwitch(1);
    e.preventDefault();
  },{passive:false});
  // --- MOBILE SWIPE ---
  let touchStartX=null, touchStartY=null, touchMoved=false;
  CANVAS.addEventListener('touchstart', e=>{
    if (!CAT.canControl) return;
    touchMoved=false;
    let t = e.touches[0];
    touchStartX=t.clientX; touchStartY=t.clientY;
  },{passive:false});
  CANVAS.addEventListener('touchmove', e=>{
    if (!CAT.canControl) return;
    let t = e.touches[0];
    let dx = t.clientX-touchStartX, dy = t.clientY-touchStartY;
    if (Math.abs(dx)>Math.abs(dy)&&Math.abs(dx)>26) {
      laneSwitch(dx>0?1:-1);
      touchStartX=t.clientX; // Allow rapid switches
      touchMoved=true;
    } else if (Math.abs(dy)>Math.abs(dx)&&dy<-23) {
      jump();
      touchMoved=true;
      touchStartY=t.clientY;
    } else if (Math.abs(dy)>Math.abs(dx)&&dy>23) {
      duck();
      touchMoved=true;
      touchStartY=t.clientY;
    }
    e.preventDefault();
  },{passive:false});
  CANVAS.addEventListener('touchend', e=>{
    if (!CAT.canControl) return;
    if (!touchMoved) jump(); // Tap = jump
    touchStartX=null; touchStartY=null; touchMoved=false;
    e.preventDefault();
  },{passive:false});
  document.body.addEventListener('touchmove', function(e){e.preventDefault();},{passive:false});
  document.body.addEventListener('scroll', function(e){window.scrollTo(0,0);});
  CANVAS.addEventListener('click',()=>CANVAS.focus());

  // ===== BUTTONS =====
  document.getElementById('feedBtn').onclick=()=>{
    if (!GAME.running||!CAT.canControl) return;
    if (STATS.hunger>95) {displayMessage("Ninja is full!");return;}
    STATS.hunger=Math.min(100,STATS.hunger+23);
    updateStatsUI();
    displayMessage("Ninja Sushi! üç£","#e4a700");
    STATS.happiness=Math.min(100,STATS.happiness+8);
    STATS.energy=Math.min(100,STATS.energy+3);
  };
  document.getElementById('petBtn').onclick=()=>{
    if (!GAME.running||!CAT.canControl) return;
    STATS.happiness=Math.min(100,STATS.happiness+11);
    updateStatsUI();
    displayMessage("Purr... üêæ","#fa9bb2");
    GAME.petPopup=38;
  };
  document.getElementById('sleepBtn').onclick=()=>{
    if (!GAME.running||!CAT.canControl) return;
    if (CAT.state==="sleep") {displayMessage("Already meditating!");return;}
    if (STATS.energy>65) {displayMessage("Not sleepy yet.");return;}
    CAT.state="sleep"; CAT.canControl=false;
    displayMessage("Zzz... üò¥","#ffe35e",1700);
  };
  document.getElementById('restartBtn').onclick=()=>{
    resetGame();
    requestAnimationFrame(gameLoop);
  };
  // ===== PERSISTENCE =====
  let hs=+localStorage.getItem('ninjacatsurfers_highscore');
  if (!isNaN(hs)) {
    GAME.highscore=hs;
    document.getElementById('highscore').textContent="Best: "+Math.floor(GAME.highscore);
  }
  // ===== STORYLINE =====
  const storyFrames = [
    {
      text: "In the neon-lit alleys of Meowkyo City, a daring ninja cat named Neko has just pulled off the ultimate heist...",
      anim: "steal"
    },
    {
      text: "Clutching the legendary <b>Golden Sushi Roll</b>, Neko darts into the night! But wait... the Cat Guards have spotted the thief!",
      anim: "run"
    },
    {
      text: "With a yowl, the Cat Guards give chase. Neko must run, leap, and dodge obstacles to escape with the prize.",
      anim: "chase"
    },
    {
      text: "Help Ninja Neko outrun the Cat Guards!<br><br><small>Swipe or tap to jump, swipe left/right to change lanes. Collect sushi, avoid obstacles, and keep your ninja skills sharp!</small>",
      anim: "ready"
    }
  ];
  let storyIdx = 0;
  function showStoryline(callback) {
    const storyDiv = document.getElementById('storyline');
    const storyCanvas = document.getElementById('story-canvas');
    const storyCtx = storyCanvas.getContext('2d');
    storyDiv.classList.add('active');
    storyIdx = 0;
    renderStoryFrame(storyFrames[storyIdx]);
    document.getElementById('story-btn').onclick = ()=>{
      storyIdx++;
      if (storyIdx < storyFrames.length) {
        renderStoryFrame(storyFrames[storyIdx]);
      } else {
        storyDiv.classList.remove('active');
        CAT.canControl = true;
        if (callback) callback();
      }
    };
    function renderStoryFrame(frame) {
      drawStoryAnim(storyCtx,frame.anim,storyCanvas.width,storyCanvas.height,()=>{});
      document.getElementById('story-text').innerHTML = frame.text;
    }
  }
  function drawStoryAnim(ctx, anim, W, H, cb) {
    // Clear
    ctx.clearRect(0,0,W,H);
    // BG
    ctx.save();
    ctx.fillStyle = "#232942";
    ctx.fillRect(0,0,W,H);
    // Neon city
    for(let i=0;i<4;i++){
      let x = 60+i*80;
      ctx.fillStyle="#31386b";
      ctx.fillRect(x,H-70,32,48+randomInt(-6,10));
    }
    if (anim==="steal") {
      // Ninja cat sneaking, paw on a glowing sushi
      drawCatStory(ctx, W/2-66, H-140, "sneak", true);
      drawSushiGlow(ctx, W/2+30, H-115, 1);
    } else if (anim==="run") {
      // Ninja cat running with sushi, motion lines
      drawCatStory(ctx, W/2-46, H-128, "run", true, true);
      drawSushiGlow(ctx, W/2+44, H-118, 0.8);
      ctx.save();
      ctx.strokeStyle="#ffe35e";
      ctx.globalAlpha=0.28;
      ctx.lineWidth=8;
      ctx.beginPath();
      ctx.moveTo(W/2-16,H-98); ctx.lineTo(W/2+32,H-88);
      ctx.stroke();
      ctx.restore();
    } else if (anim==="chase") {
      // Cat guard chasing, ninja cat ahead, alert icon
      drawCatStory(ctx, W/2-24, H-124, "run", true, true);
      drawCatGuardStory(ctx, W/2-70, H-120, "chase");
      ctx.font="bold 30px Arial";
      ctx.fillStyle="#ffe35e";
      ctx.save();
      ctx.globalAlpha=0.6;
      ctx.fillText("!", W/2-58, H-152);
      ctx.restore();
      drawSushiGlow(ctx, W/2+56, H-115, 0.7);
    } else if (anim==="ready") {
      // Ninja cat heroic pose, bandana fluttering
      drawCatStory(ctx, W/2-12, H-128, "hero", true, false, true);
      drawSushiGlow(ctx, W/2+52, H-114, 0.9);
      // Cat guard in background, faded
      drawCatGuardStory(ctx, W/2-80, H-120, "idle", 0.3);
    }
    ctx.restore();
    if (cb) cb();
  }
  function drawSushiGlow(ctx,x,y,scale=1) {
    ctx.save();
    ctx.globalAlpha=0.49;
    ctx.beginPath();
    ctx.arc(x,y+7,18*scale,0,2*Math.PI);
    ctx.fillStyle="#ffe35e";
    ctx.shadowColor="#ffe35e";
    ctx.shadowBlur=16;
    ctx.fill();
    ctx.globalAlpha=1;
    ctx.shadowBlur=0;
    ctx.beginPath();
    ctx.ellipse(x,y,21*scale,11*scale,0,0,2*Math.PI);
    ctx.fillStyle="#fff47c";
    ctx.fill();
    ctx.beginPath();
    ctx.ellipse(x,y-3,9*scale,4*scale,0,0,2*Math.PI);
    ctx.fillStyle="#e4a700"; ctx.globalAlpha=0.8; ctx.fill();
    ctx.globalAlpha=1;
    ctx.restore();
  }
  function drawCatStory(ctx,x,y,pose,hasBandana,hasSushi,hero) {
    ctx.save();
    ctx.translate(x,y);
    // Body
    ctx.fillStyle="#232942";
    ctx.beginPath();
    ctx.ellipse(28,36,24,18,0,0,2*Math.PI);
    ctx.fill();
    ctx.fillStyle="#b21f2d";
    ctx.fillRect(10,48,36,7);
    // Head
    ctx.save();
    ctx.translate(29,12);
    let headTilt=0;
    if (pose==="sneak") headTilt=-0.2;
    else if (pose==="run") headTilt=0.11;
    else if (pose==="hero") headTilt=-0.09;
    ctx.rotate(headTilt);
    ctx.translate(-29,-12);
    // Ears
    ctx.beginPath();
    ctx.moveTo(9,17); ctx.lineTo(20,1); ctx.lineTo(26,17); ctx.closePath();
    ctx.fillStyle="#424c6e"; ctx.fill();
    ctx.beginPath();
    ctx.moveTo(48,17); ctx.lineTo(37,1); ctx.lineTo(32,17); ctx.closePath();
    ctx.fill();
    // Face
    ctx.beginPath();
    ctx.ellipse(29,21,16,13.5,0,0,2*Math.PI);
    ctx.fillStyle="#353c67";
    ctx.fill();
    ctx.beginPath();
    ctx.ellipse(29,21,15,11,0,0,2*Math.PI);
    ctx.fillStyle="#232942";
    ctx.fill();
    // Eyes
    ctx.fillStyle="#ffe35e";
    if (pose==="sneak") {
      ctx.fillRect(18,26,4,4); ctx.fillRect(38,26,4,4);
    } else if (pose==="hero") {
      ctx.beginPath();
      ctx.arc(20,24,3.9,0,2*Math.PI); ctx.arc(38,24,3.9,0,2*Math.PI); ctx.fill();
      ctx.fillStyle="#fff";
      ctx.beginPath();
      ctx.arc(21.8,23,1.1,0,2*Math.PI); ctx.arc(39.8,23,1.1,0,2*Math.PI); ctx.fill();
    } else {
      ctx.beginPath();
      ctx.arc(20,24,3.6,0,2*Math.PI); ctx.arc(38,24,3.6,0,2*Math.PI); ctx.fill();
      ctx.fillStyle="#fff";
      ctx.beginPath();
      ctx.arc(21.8,23,1,0,2*Math.PI); ctx.arc(39.8,23,1,0,2*Math.PI); ctx.fill();
    }
    // Bandana
    if (hasBandana) {
      ctx.save();
      ctx.translate(10,17);
      ctx.rotate(-0.6+Math.sin(Date.now()/400)*0.18);
      ctx.fillStyle="#b21f2d";
      ctx.fillRect(0,0,16,4);
      ctx.restore();
    }
    ctx.restore();
    // Paw holding sushi
    if (hasSushi) {
      ctx.save();
      ctx.translate(54,28);
      ctx.rotate(0.34);
      drawSushiGlow(ctx,0,0,0.6);
      ctx.restore();
    }
    ctx.restore();
  }
  function drawCatGuardStory(ctx,x,y,pose,alpha=1) {
    ctx.save();
    ctx.globalAlpha=alpha;
    ctx.translate(x,y);
    ctx.fillStyle="#3f2e2a";
    ctx.beginPath();
    ctx.ellipse(27,44,17,13,0,0,2*Math.PI);
    ctx.fill();
    ctx.fillStyle="#2a1f1a";
    ctx.beginPath();
    ctx.ellipse(27,20,15,13,0,0,2*Math.PI);
    ctx.fill();
    ctx.fillStyle="#ffe35e";
    ctx.fillRect(20,23,4,4);
    ctx.fillRect(30,23,4,4);
    ctx.fillStyle="#b21f2d";
    ctx.fillRect(13,13,28,7);
    ctx.beginPath();
    ctx.moveTo(10,10); ctx.lineTo(15,0); ctx.lineTo(18,14); ctx.closePath();
    ctx.fillStyle="#42312a"; ctx.fill();
    ctx.beginPath();
    ctx.moveTo(38,10); ctx.lineTo(33,0); ctx.lineTo(30,14); ctx.closePath();
    ctx.fill();
    ctx.restore();
  }

  // ===== INIT & STORYLINE START =====
  updateStatsUI(); setScore(0);
  fitCanvas();
  showStoryline(()=>{
    resetGame(true);
    requestAnimationFrame(gameLoop);
  });
  document.getElementById('overlay').addEventListener('click',e=>{
    if (e.target===document.getElementById('overlay')) {
      hideOverlay();
      resetGame();
      requestAnimationFrame(gameLoop);
    }
  });
  window.scrollTo(0,0);
  window.addEventListener('resize', fitCanvas);
  let lastTouch=0;
  document.body.addEventListener('touchend',function(e){
    let now=new Date().getTime();
    if(now-lastTouch<=300){e.preventDefault();}
    lastTouch=now;
  },{passive:false});
  </script>
</body>
</html>
